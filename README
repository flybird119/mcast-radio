Mateusz Machalica; 305678; SIK; "Radio internetowe"
===================================================

OPIS PROTOKOŁU
--------------

Wszystkie wartości składające się z więcej niż jednego bajta przechowywane są w sieciowym porządku bajtów.

Format pakietu
---------------

Pakiety przesyłane są w formie datagramów UDP.
Pakiet składa się z nagłówka i sekcji danych.
Format sekcji danych jest zależny od flag ustawionych w nagłówku.

Format nagłówka
---------------

Nagłówek ma następujący format:

|      2 oktety     | 1 oktet | 1 oktet |
+-------------------+---------+---------+
|       numer sekwencyjny pakietu       |
+-------------------+---------+---------+
|  długość pakietu  |  flagi  |  wersja |
+-------------------+---------+---------+

Numer sekwencyjny pakietu to 32-bitowa liczba bez znaku, ma znaczenie tylko dla pakietów z ustawioną flagą DATA (patrz dalej).

Długość pakietu to 16-bitowa liczba bez znaku, równa długości pakietu (długość nagłówka + długość danych) wyrażonej w oktetach.

Wersja to 8-bitowa liczba bez znaku, równa wersji protokołu, obecnie 1.

Flagi to 8-bitowa liczba bez znaku, równa sumie bitowej podzbioru następujących wartości:
	RETQUERY    0x1
	IDQUERY     0x2
	IDRESP      0x4
	DATA        0x8
	FAIL        0xF
Powiemy, że flaga X jest ustawiona w nagłówku, jeśli pole flagi nagłówka ma wartości Y i Y & X != 0.
Podobnie flaga jest ustawiona w pakiecie jeśli jest ustawiona w nagłówku tego pakietu.

Pewne pary flag X != Y nazwiemy sprzecznymi.
Pakiet z ustawionymi dwiema sprzecznymi flagami, nie jest poprawnym pakietem protokołu.
Niech każde dwie różne flagi są sprzeczne, chyba że w dalszej części specyfikacji zaznaczono inaczej.

Format sekcji danych
--------------------

Maksymalna długość sekcji danych wynosi 2^15 oktetów.

Format sekcji danych zależy od ustawionych flag w nagłówku pakietu.

Jeśli ustawiona jest jedna z flag:
	RETQUERY (pakiet z prosbą o retransmisję, numer sekwenycjny w nagłówku jest numerem pakietu o którego retransmisję prosimy)
	IDQUERY (pakiet z prośbą o identyfikację)
	FAIL (pakiet informujący o niemożności retransmisji o numerze sekwencyjnym takim jak numer w nagłóku pakietu)
to sekcja danych jest pusta (ma 0 bajtów).

Flagi RETQUERY i IDQUERY nie są sprzeczne.

Jeśli ustawiona jest flaga IDRESP (pakiet z odpowiedzią na prośbę o identyfikację) to sekcja danych ma następujący format:
- NAME_LEN oktetów zawierających nazwę stacji wysyłającej ten pakiet zapisaną jako NULL Terminated String (dopełnione do wymaganej liczby oktetów zerami)
- NAME_LEN oktetów zawierających nazwę aplikacji wysyłającej ten pakiet zapisaną jako NULL Terminated String (dopełnione do wymaganej liczby oktetów zerami)
- 16-bitową liczbę bez znaku oznaczającą rozmiar sekcji danych w pakiecie PSIZE z ustawioną flagą DATA w nagłówku, wysyłanym przez tą stację
- blok 128 oktetów zawierający wyrównaną do poczatku bloku zawartość struktury struct sockaddr_storage zdefiniowanej w RFC 2553, która zawiera adres i port adresu rozgłoszeniowego na którym nadaje stacja wysyłająca ten pakiet
- blok 128 oktetów zawierający wyrównaną do poczatku bloku zawartość struktury struct sockaddr_storage zdefiniowanej w RFC 2553, która zawiera adres i port adresu lokalnego, z którego nadaje na adres rozgłoszeniowy stacja wysyłająca ten pakiet

Jeśli ustawiona jest flaga DATA (pakiet z danymi) to sekcja danych zawiera ciąg oktetów, które stanowią przesyłane dane.

Opis nadajnika
------------------

Nadajnik nasłuchuje na portach jak opisano w sformułowaniu zadania i odpowiada na prosby o identyfikację opisanym juz pakietem.

Po otrzymaniu prośby o retransmisję pakietu sprawdza czy znajduje się on w kolejce fifo, jeśli tak to zaznacza pakiet jako do retransmisji, jeśli pakiet nie znajduje się w kolejce fifo to na adres (i numer portu) z którego otrzymano prośbe odsyłany jest pakiet z informacją o niemożności retransmisji.

Co czas RTIME nadajnik ponownie wysyła wszystkie pakiety jakie znajdują się w kolejce fifo i zostały zaznaczone jako do retransmisji oraz odznacza je.

Opis odbiornika
-------------------

Odbiornik wysyła prosby o identyfikację i odbiera odpowiedzi jak zdefiniowano w sformułowaniu zadania.

Bufor odbiornika zawiera dane przesłane w pakietach i dane zawarte w ich nagłówkach w osobnej strukturze danych.
Długością bufora nazwiemy sufit(BSIZE/PSZIE).
Bufor przechowuje pakiety poczynając od pewnego numeru sekwencyjnego fseqno do większego numeru sekwencyjnego lseqno < fseqno + długość bufora, wraz z lukami (jeśli pakiet o danym numerze sekwencyjnym jeszcze nie przyszedł jego numer sekwencyjny należy do przedziału domkniętego [fseqno, lseqno], to pod tym numerem w buforze znajduje sie luka).
Wartości fseqno i lseqno oznaczaja odpowiednio pierwszy (porządek na numerach sekwencyjnych) pakiet w buforze i ostatni pakiet jaki został odebrany.
Bufor jest wstepnie (po uruchomieniu lub zmianie stacji) niezainicjowany, przed uzyciem bufora nalerzy go zainicjowac, co oznacza ustalenie fseqno.
Spójnym prefiksem bufora nazwiemy ciąg pakietów o rosnących numerach sekwencyjnych począwszy od fseqno, takich że wszystkie znajdują się w buforze (nie ma w na miejscach w buforze luk).

Gdzy przychodzi nowy pakiet, odbiornik wykonuje:
- jeslli lseqno bufora jest mniejsze od numeru sekwencyjnego nowego pakietu o więcej niż dwie długości bufora to czyni bufor niezainicjowanym
- jesli bufor jest niezainicjowany to inicjuje bufor i wstawia do niego nowy pakiet alktualizując lseqno
- wszystkie pakiety o numerach sekwencyjnych pomiędzy fseqno i lseqno, które jeszcze nie przyszły zaznacza jako luki i zaznacza jako do retransmisji ustalając opóźnienie retransmisji na 1 jednostkę (patrz dalej) i liczbę retransmisji na 8.
- jeśli zajduje się spójny prefiks o długości co najmniej 75% długości bufora to opróżnia pierwsze (długość najdłuższego spójnego prefiksu)-pakietów bufora na standardowe wyjście 
- jeśli lseqno-fseqno >= długość bufora - 1, to usuwamy z bufora pakiety (od początku, a więc numeru sekwencyjnego fseqno) aż do pierwszego pakietu (nie luki) po pierwszej luce w buforze.

Co RTIME odbiornik przegląda bufor w poszukiwaniu luk i dla każdej luki, jeśli znajduje się w pierwszej polowie bufora i jeśli odebrał już pakiet o mniejszym oraz wiekszym numerze sekwencyjnym to:

% TODO to co w rtime_cb

% TODO opróżnianie bufora
