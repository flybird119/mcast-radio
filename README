Mateusz Machalica; 305678; SIK; "Radio internetowe"
===================================================

OPIS PROTOKOŁU
--------------

Wszystkie wartości liczbowe składające się z więcej niż jednego bajta przechowywane są w sieciowym porządku bajtów.

Format pakietu
---------------

Pakiety przesyłane są w formie datagramów UDP.
Pakiet składa się z nagłówka i sekcji danych.
Format sekcji danych jest zależny od flag ustawionych w nagłówku.

Format nagłówka
---------------

Nagłówek ma następujący format:

|      2 oktety     | 1 oktet | 1 oktet |
+-------------------+---------+---------+
|       numer sekwencyjny pakietu       |
+-------------------+---------+---------+
|  długość pakietu  |  flagi  |  wersja |
+-------------------+---------+---------+

Numer sekwencyjny pakietu to 32-bitowa liczba bez znaku, ma znaczenie tylko dla pakietów z ustawioną flagą DATA (patrz dalej).

Długość pakietu to 16-bitowa liczba bez znaku, równa długości pakietu (długość nagłówka + długość danych) wyrażonej w oktetach.

Wersja to 8-bitowa liczba bez znaku, równa wersji protokołu, obecnie 1.

Flagi to 8-bitowa liczba bez znaku, równa sumie bitowej podzbioru następujących wartości:
	RETQUERY    0x1
	IDQUERY     0x2
	IDRESP      0x4
	DATA        0x8
	FAIL        0xF
Powiemy, że flaga X jest ustawiona w nagłówku, jeśli pole flagi nagłówka ma wartości Y i Y & X != 0.
Podobnie flaga jest ustawiona w pakiecie jeśli jest ustawiona w nagłówku tego pakietu.

Pewne pary flag X != Y nazwiemy sprzecznymi.
Pakiet z ustawionymi dwiema sprzecznymi flagami, nie jest poprawnym pakietem protokołu.
Niech każde dwie różne flagi są sprzeczne, chyba że w dalszej części specyfikacji zaznaczono inaczej.

Format sekcji danych
--------------------

Maksymalna długość sekcji danych wynosi 2^15 oktetów.

Format sekcji danych zależy od ustawionych flag w nagłówku pakietu.

Jeśli ustawiona jest jedna z flag:
	RETQUERY (pakiet z prośbą o retransmisję, numer sekwencyjny w nagłówku jest numerem pakietu o którego retransmisję prosimy)
	IDQUERY (pakiet z prośbą o identyfikację)
	FAIL (pakiet informujący o niemożności retransmisji o numerze sekwencyjnym takim jak numer w nagłówku pakietu)
to sekcja danych jest pusta (ma 0 bajtów).

Flagi RETQUERY i IDQUERY nie są sprzeczne. Pakiet, który zawiera ustawione obie flagi jest traktowany jak dwa osobne pakiety z ustawionymi flagami pojedynczo.

Jeśli ustawiona jest flaga IDRESP (pakiet z odpowiedzią na prośbę o identyfikację) to sekcja danych ma następujący format:
- 32 oktety zawierających nazwę stacji wysyłającej ten pakiet zapisaną jako NULL Terminated String (dopełnione do wymaganej liczby oktetów zerami)
- 32 oktety zawierających nazwę aplikacji wysyłającej ten pakiet zapisaną jako NULL Terminated String (dopełnione do wymaganej liczby oktetów zerami)
- 16-bitową (2 oktety) liczbę bez znaku oznaczającą rozmiar sekcji danych w pakiecie PSIZE z ustawioną flagą DATA w nagłówku, wysyłanym przez tą stację
- blok adresowy, 128 oktetów, zawierający wyrównaną do początku bloku zawartość struktury struct sockaddr_storage zdefiniowanej w RFC 2553, która zawiera adres i port adresu rozgłoszeniowego na którym nadaje stacja wysyłająca ten pakiet
- blok adresowy, 128 oktetów, zawierający wyrównaną do początku bloku zawartość struktury struct sockaddr_storage zdefiniowanej w RFC 2553, która zawiera adres i port adresu lokalnego, z którego nadaje na adres rozgłoszeniowy stacja wysyłająca ten pakiet

Format bloku adresowego:
- 2 oktety - nieużywane
- 16-bitowa liczba ze znakiem oznaczająca port TCP/UDP
- 32-bitowa liczba ze znakiem oznaczająca adres IPv4, w formacie zgodnym z tym, zwracanym przez funkcję inet_pton w standardzie IEEE Std 1003.1, 2003 Edition, Standard for Information Technology -- Portable Operating System Interface (POSIX)
- reszta oktetów - nieużywane

Kompatybilność z sockaddr_storage pozwala na rozszerzenia w przyszłości protokołu o wsparcie IPv6.

Jeśli adres (adres IP i numer portu) gniazda, z którego będą nadawane pakiety z danymi na adres rozgłoszeniowy nie będzie zgodny z tym zadeklarowanym przez stację w bloku adresowym pakietu identyfikacyjnego, to taki pakiety będą odrzucane przez odbiornik.

Jeśli ustawiona jest flaga DATA (pakiet z danymi) to sekcja danych zawiera ciąg oktetów, które stanowią przesyłane dane.

Opis nadajnika
------------------

Nadajnik nasłuchuje na portach jak opisano w sformułowaniu zadania i odpowiada na prośby o identyfikację opisanym już pakietem.

Po otrzymaniu prośby o retransmisję pakietu sprawdza czy znajduje się on w kolejce fifo, jeśli tak to zaznacza pakiet jako do retransmisji, jeśli pakiet nie znajduje się w kolejce fifo to na adres (i numer portu) z którego otrzymano prośbę odsyłany jest pakiet z informacją o niemożności retransmisji.

Co czas RTIME nadajnik ponownie wysyła wszystkie pakiety jakie znajdują się w kolejce fifo i zostały zaznaczone jako do retransmisji oraz odznacza je.

Opis odbiornika
-------------------

Odbiornik wysyła prśsby o identyfikację i odbiera odpowiedzi jak zdefiniowano w sformułowaniu zadania, nasłuchuje również na tym porcie, z którego prosi o retransmisje, pakietów informujących o niemożności retransmisji.

Bufor odbiornika składa się z wpisów, wpisem może być odebrany pakiet, luka (pakiet, który został oznaczony do retransmisji), martwy pakiet (pakiet, o którego retransmisję nie będziemy już prosić), miejsce wolne (może stać się jednym z powyższych).
Miejscami wolnymi sa wszystkie wpisy po ostatnim (porządek na pakietach indukowany z porządku na numerach sekwencyjnych) odebranym pakiecie (jeśli nie ma odebranego pakietu, to cały bufor składa się z wolnych miejsc).
Długością bufora jest sufit(BSIZE/PSZIE).
Bufor przechowuje wpisy dla numerów sekwencyjnych od fseqno do lseqno = fseqno + długość bufora - 1.
Poprawnym prefiksem nazwiemy ciąg odebranych pakietów w buforze o kolejnych numerach sekwencyjnych począwszy od fseqno.
Początkowo (i po każdej zmianie stacji) bufor jest niezainicjowany, nie ma określonego fseqno, nie można wtedy wykonywać na nim żadnych operacji poza inicjalizacją (ustaleniem fseqno).

Parametry luki:
- liczba retransmisji - ile razy można jeszcze prosić o retransmisję, jeśli równe zero to już nie można prosić o retransmisję pakietu (który znalazłby się pod tym wpisem)
- opóźnienie retransmisji - ile razy RTIME trzeba jeszcze czekać, aby poprosić o retransmisję (w obecnej implementacji rozdzielczość pomiaru czasu to RTIME)

Przejścia pomiędzy rodzajami wpisów:
- wolne miejsce >>== oznaczenie do retransmisji ==>> luka
	- ustawia opóźnienie retransmisji na 1
	- ustawia liczbę retransmisji na 8
- luka >>== prośba o retransmisję ==>> luka
	- zmniejszenie liczby retransmisji o 1
	- ustawienie opóźnienia retransmisji na 2
- wolne miejsce, luka >>= odebranie pakietu ==>> odebrany pakiet
- luka >>== odebranie informacji (pakietu) o niemożności retransmisji ==>> martwy pakiet
- luka >>== liczba retransmisji i opóźnienie retransmisji równe zero ==>> martwy pakiet

Gdy przychodzi nowy pakiet (z aktualnie ustawionej stacji) o numerze sekwencyjnym seqno:
- jeśli seqno-lseqno >  2 * długośc bufora to bufor staje się niezainicjowany
- jeśli bufor jest niezainicjowany to inicjuje bufor aktualnym seqno
- jeśli seqno > fseqno, to z bufora jest usuwanych pierwszych seqno - fseqno pakietów
- wstawia do bufora nowy odebrany pakiet (o numerze sekwencyjnym seqno)
- wszystkie wpisy w buforze o numerach sekwencyjnych < seqno, które są miejscami wolnymi stają się lukami (oznaczone do retransmisji)
- jeśli w buforze jest poprawny prefiks o długości co najmniej 75% długości bufora to opróżnia pierwsze (długość najdłuższego spójnego prefiksu)-pakietów bufora na standardowe wyjście 

Co RTIME odbiornik:
- przegląda bufor w poszukiwaniu ostatniego martwego pakietu i usuwa wszystkie pakiety o mniejszym lub równym numerze sekwencyjnym
- dekrememntuje opóźnienie retransmisji dla każdej luki w buforze o dodatnim opóźnieniu retransmisji (luki, które spełniają)
- dla każdej luki, jeśli znajduje się w pierwszej połowie bufora i jeśli opóźnienie retransmisji jest równe zero i liczba retransmisji większa od zera to:
	- wysyła prośbę o retransmisje tego pakietu
	- zmienia rodzaj wpisu luka >>==>> luka (aktualizacja liczby i opóźnienia retransmisji)

